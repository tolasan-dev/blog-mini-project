<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f8f9fa;
        font-family: "Poppins", sans-serif;
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 230px;
        background: linear-gradient(135deg, #ff9a9e, #fad0c4);
        color: white;
        display: flex;
        flex-direction: column;
        padding: 30px 20px;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .sidebar h4 {
        font-weight: 700;
        margin-bottom: 40px;
        text-align: center;
      }

      .sidebar a {
        color: white;
        text-decoration: none;
        margin: 10px 0;
        padding: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
        display: block;
      }

      .sidebar a:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
      }

      /* Main content */
      .main-content {
        flex: 1;
        padding: 40px;
        overflow-y: auto;
      }

      .main-content h2 {
        font-weight: 600;
        color: #333;
      }

      /* Profile card on the right */
      .profile-card {
        width: 300px;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        padding: 25px;
        position: absolute;
        right: 30px;
        top: 30px;
        text-align: center;
      }

      .profile-card img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
      }

      .profile-card h5 {
        font-weight: 600;
        margin-bottom: 5px;
      }

      .profile-card p {
        color: #555;
        font-size: 14px;
      }

      .logout-btn {
        background: linear-gradient(135deg, #ff758c, #ff7eb3);
        border: none;
        color: #fff;
        padding: 10px 20px;
        border-radius: 8px;
        margin-top: 15px;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        background: linear-gradient(135deg, #ff5f7e, #ff85a2);
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h4>My Dashboard</h4>
      <a href="#">üè† Home</a>
      <a href="#">üì∞ My Posts</a>
      <a href="#">‚öôÔ∏è Settings</a>
      <a href="#">üì© Messages</a>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <h2 id="welcomeMessage">Welcome, User!</h2>
      <p class="text-muted">Here is your personalized dashboard content...</p>
      <hr />
    </div>

    <!-- Profile Card -->
    <div class="profile-card">
      <img id="avatar" alt="User Avatar" onclick="openfile()"><br>
      <button onclick="deleteAvatar()">Delete Avatar</button><br><br>
      <input type="file" id="avatar" accept="image/*" oninput="uploadAvatar()" />
      <h5 id="username">User Name</h5>
      <p id="email">user@example.com</p>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <script>
      function openfile() {
        document.querySelector(".profile-card input[type='file']").click();
        // document.getElementById('avatar').click();
      }

      if (localStorage.getItem("token")) {
        const username = document.getElementById("welcomeMessage");
        const email = document.getElementById("email");
        const avatarImg = document.querySelector(".profile-card img"); // safely select the image

        fetch("http://blogs.csm.linkpc.net/api/v1/auth/profile", {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            console.log(data);
            const profile = data.data;
            username.innerText = `Welcome, ${profile.firstName} ${profile.lastName}!`;
            email.innerText = profile.email;
            avatarImg.src = profile.avatar;
          });
      } else {
        location.href = "login.html";
      }

      function logout() {
        fetch("http://blogs.csm.linkpc.net/api/v1/auth/logout", {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            console.log(data);
            localStorage.removeItem("token");
            location.href = "login.html";
          });
      }

      function uploadAvatar() {
        // target file input correctly
        const fileInput = document.querySelector(".profile-card input[type='file']");
        const avatarFile = fileInput.files[0];
        const avatarImg = document.querySelector(".profile-card img");

        const formData = new FormData();
        formData.append("avatar", avatarFile);

        // convrt from file into url
        console.log(URL.createObjectURL(avatar));
        document.getElementById('avatar').src = URL.createObjectURL(avatar);

        fetch("http://blogs.csm.linkpc.net/api/v1/profile/avatar", {
          method: "POST",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("token")}`,
          },
          body: formData,
        })
          .then((res) => res.json())
          .then((data) => {
            console.log("Upload response:", data);
            if (data.data && data.data.avatar) {
              avatarImg.src = data.data.avatar; // update immediately
              alert("Avatar uploaded successfully!");
            } else {
              alert("Upload completed, but no image returned from server.");
            }
          })
          .catch((err) => {
            console.error("Upload error:", err);
            alert("Failed to upload avatar.");
          });
      }
      function deleteAvatar(){
        fetch("http://blogs.csm.linkpc.net/api/v1/profile/avatar", {
          method: "DELETE",
          headers: {
            'Authorization': `Bearer ${localStorage.getItem("token")}`,
          },
        
        })
        .then(res => res.json())
        .then(data => {
          document.getElementById('avatar').src = data.data.avatar;
        });
      }
      
    </script>
  </body>
</html>
